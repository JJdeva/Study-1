# 1. 대량 데이터 발생에 따른 테이블 분할 개요

대량의 데이터가 존재하는 테이블에 많은 트랜잭션이 발생하여 성능이 저하되는 테이블 구조는 수평/수직 분할 설계를 통해 성능 저하를 예방할 수 있다.

![](/bin/db_image/SQLD_4_4_1.png)

- 수평 분할
	- 행 단위로 분할하여 Input/Output을 감소시키는 방법이다.
	- 예시)
		- 1년치 데이터가 대용량인 경우 월별로 분할하여 저장한다면 특정 월을 조회하는 경우에는 해당 월만 조회하면 된다.
- 수직 분할
	- 칼럼 단위로 분할하여 I/O를 감소시키는 방법이다.
	- 예시)
		- 고객의 생년월일, 주소 등의 개인정보와 취미/특기 등의 기타정보를 별도로 저장할 수 있다.

```ad-info
title: I/O에 대한 추가 설명

- 테이블 내에 모든 행은 블록(Block) 단위로 디스크에 저장된다.
- 오라클 DBMS 기준 1개의 블록은 8,192바이트(=8킬로바이트)이다.
	- 하나의 블록마다 8,192바이트를 저장하고, 그러한 블록이 모여서 테이블의 데이터를 이루게 된다.
- 칼럼이 많아지게 되면 하나의 행을 저장 시 물리적인 디스크에 여러 블록에 걸쳐 데이터가 저장될 가능성이 높아진다.
	- 이러한 경우 하나의 행을 읽더라도 여러 개의 블록을 읽어야 한다.
- 특정 테이블에서 한 행의 용량이 8,193바이트라고 가정하면 하나의 행을 읽더라도 2개의 블록을 읽게 된다.
	- 2개의 블록을 읽었으니 총 16,384바이트를 읽게 되고 그 중 8,191바이트는 버려진다.
- 자연스레 SQL문의 블록 I/O의 수가 많아지게 되어 성능 저하가 일어난다.

```

대용량 테이블에서 발생할 수 있는 성능 저하 현상에는 로우 체이닝과 로우 마이그레이션이 있다.

- 로우 체이닝(Row Chaining)
	- 로우 길이가 너무 길어서 데이터 블록 하나에 데이터가 모두 저장되지 않고, 2개 이상의 블록에 걸쳐 하나의 로우가 저장되어 있는 형태이다.
	- 하나의 행을 읽을 때 2개 이상의 데이터 블록을 읽게 될 수 있는 것이다.
	- 절대적으로 읽어야 할 데이터 블록의 수가 늘어나면서 성능이 저하된다.
- 로우 마이그레이션(Row Migration)
	- 데이터 블록에서 수정이 발생하면 수정된 데이터를 해당 데이터 블록에서 저장하지 못하고, 다른 블록의 빈 공간을 찾아 저장하는 방식이다.
	- 해당 현상이 일어나면서 하나의 행을 읽을 때 2개 이상의 데이터 블록을 읽게 된다.
	- 로우 체이닝 현상과 마찬가지로 절대적으로 읽어야 할 데이터 블록의 수가 늘어나면서 성능이 저하된다.

로우 체이닝과 로우 마이그레이션이 발생하여 많은 블록에 데이터가 저장되면 데이터 조회 시 절대적인 블록 I/O의 횟수가 많아지게 된다. 블록 I/O의 횟수가 많아지면 디스크(Disk) I/O를 할 가능성도 높아진다. 디스크 I/O는 특정 블록을 데이터베이스 내 메모리에서 찾을 수 없어서 디스크를 읽게 되는 상황을 뜻한다. 디스크 I/O는 고비용의 작업이므로 DBMS 성능의 급격한 저하를 유발한다.

# 2. 한 테이블에 많은 수의 칼럼을 가지는 경우의 성능 저하

![](/bin/db_image/SQLD_4_4_2.png)

이 테이블에서 자주 조회하는 SQL

![](/bin/db_image/SQLD_4_4_3.png)

이 SQL문이 실행될 때마다 도서정보 테이블에 있는 모든 칼럼을 읽게 되고, 그 중 조회대상이 아닌 칼럼은 버려지게 되어 불필요한 블록 I/O의 수가 많아진다. 블록 I/O가 많아지면 자연스레 디스크 I/O의 양도 증가된다. 디스크 I/O가 많아지면 DBMS의 전체 성능이 저하된다. 이 경우 도서정보 테이블을 수직 분할하면 성능이 향상될 수 있다.

![](/bin/db_image/SQLD_4_4_4.png)

도서정보 테이블을 도서정보, 도서전자출판, 도서대체 테이블로 수직 분할하였다. 이렇게하면 동일한 SQL문을 호출 시 읽어들이는 블록 I/O의 수가 감소한다.

도서정보 테이블과 도서전자출판 테이블 간의 관계는 1:1 관계이다. 도서정보 테이블과 도서대체 테이블 간의 관계도 1:1이다. 이것이 수직 분할의 특징이다.

```ad-info
title: 테이블 수직 분할

- 전자출판에 대한 트랜잭션이 독립적으로 발생되는 경우가 많아 1:1 관계로 수직 분할한다.
- 대체제품에 대한 트랜잭션이 독립적으로 발생되는 경우가 많아 1:1 관계로 수직 분할한다.
- 분리된 테이블은 칼럼의 수가 적어지므로, 1개의 행을 읽기 위해서 절대적으로 읽어야 할 데이터 블록의 수가 줄어들어 로우 마이그레이션과 로우 체이닝 현상이 감소한다.
- 마찬가지로 도서정보 테이블 조회 시에도 디스크 I/O가 줄어들어 성능이 좋아진다.

```

# 3. 한 테이블에 많은 수의 행을 가지는 경우의 성능 저하

대형 통신사의 요금 테이블은 매월 수천만 건씩 저장되는 대용량 테이블이다. 이 경우 요금 테이블은 행의 수가 많아서 SQL문의 성능이 저하될 수 있다.

### A. 범위 파티셔닝 (Range Partitioning)

테이블의 저장 건수가 매우 많을 때 수평 분할하여 성능을 향상시킬 수 있다. 수평 분할을 파티셔닝이라고 하며 특정 기간으로 분할하는 것을 범위 파티셔닝이라고 한다.

![](/bin/db_image/SQLD_4_4_5.png)

요금 테이블에 PK가 요금일자 + 요금번호로 구성되어 있고 데이터 건수가 1억 2천만 건인 대용량 테이블의 경우, 하나의 테이블로는 너무 많은 데이터가 존재하여 성능이 저하된 경우에 해당한다.

요금 테이블의 특성상 항상 월단위로 데이터 처리를 하는 경우가 많으므로 PK구성칼럼인 요금일자 칼럼을 이용하여 월별로 12개의 파티션 테이블을 생성한다.

이렇게 하면 데이터 보관 주기에 따라 테이블에 데이터를 쉽게 지우는 것이 가능하므로 (파티션 테이블만 DROP하면 가능) 데이터 보관 주기에 따른 테이블 관리가 용이하다. 특정 시점 기준으로 조회 시 테이블 스캔의 범위가 작으므로 동일한 SQL문이라도 성능이 좋아질 가능성이 높아지게 된다.

### B. 리스트 파티셔닝 (List Partitioning)

고객 테이블은 행의 수가 매우 많은 대용량 테이블이다. 각 지역의 사업소별로 고객을 관리한다고 했을 때, 리스트 파티셔닝을 하여 테이블을 수평 분할할 수 있다.

![](/bin/db_image/SQLD_4_4_6.png)

고객 테이블에 데이터가 1억 건이 있는데 하나의 테이블에서 데이터를 처리하기에는 SQL문의 성능이 저하되어 지역을 나타내는 사업소코드별로 리스트 파티셔닝을 적용한다.

리스트 파티셔닝은 대용량 데이터를 특정 값에 따라 분리 저장할 수는 있으나 범위 파티셔닝과 같이 데이터 보관 주기에 따라 쉽게 삭제하는 기능은 제공하지 않는다.

사업소코드가 인천인 고객만을 대상으로 데이터를 조회할 경우 고객_인천 파티션만 조회하면 되므로 SQL문의 성능이 향상될 가능성이 높아진다.

### C. 해시 파티셔닝 (Hash Partitioning)

```ad-info
title: 해시 파티셔닝

- 해시 파티셔닝은 지정된 HASH 조건에 따라 해싱 알고리즘을 적용하여 테이블을 분리한다.
- 해싱 알고리즘에 의해 각각의 해시 파티션에 분리되어 데이터가 입력되므로 기존에 1개의 테이블에만 데이터를 입력하는 방식보다 입력 시의 경합 부하가 줄어든다.
- 설계자 및 데이터 입력자는 특정 데이터가 어떤 파티션에 저장되는지 정확하게 예측할 수 없다.
- 데이터 입력 시 경합에 의한 성능 부하를 해소하기 위해 사용한다.
- 데이터 보관 주기에 따라 쉽게 삭제하는 기능을 제공할 수 없다.

```

해시 파티셔닝은 주문번호 혹은 주민등록번호와 같은 (변별력이 좋은) 칼럼을 기준으로 테이블을 분할하는 기법이다.

특정 데이터를 입력할 때 파티션 키 칼럼(주문번호 혹은 주민등록번호)의 값을 해시함수의 입력값으로 하여 해시함수가 출력하는 출력값에 따라 해당 행이 저장되는 파티션이 결정된다. 그러므로 사용자는 특정 데이터가 어디 파티션에 들어갈지 예측할 수 없다. 이러한 이유로 데이터 보관 주기에 따라 쉽게 삭제할 수 없다.

하지만 해시 파티셔닝 기법은 불특정 다수의 데이터를 자동으로 여러 개의 파티션으로 분할해서 저장하게 된다. 특정 테이블에 데이터 처리가 집중적으로 발생될 때 일어날 수 있는 경합을 해소시킬 수 있다.

### D. Composit Partitioning

# 4. 테이블에 대한 수평/수직 분할의 절차

```ad-info
title: 테이블의 수평/수직 분할 절차

1. 데이터 모델링을 완성한다.
2. 데이터베이스(각 테이블의) 용량을 산정한다.
3. 대량의 데이터가 처리되는 테이블에 대해서 트랜잭션 처리 패턴을 분석한다.
4. 칼럼 단위로 집중화된 처리가 발생하는지, 로우 단위로 집중화된 처리가 발생되는지 분석하여 처리 작업이 집중화된 단위로 테이블을 분리하는 것을 검토한다.

```

